---
title: "Trade and Territorial Disputes"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
```

## The Legalization of Transfers

Trade is positively related to the probability of agreement at the 95% level or higher in all but one model - the specification with area and population as the only controls, which has a substantially reduced n.

```{r, cache=T}
source("agreement_dataprep.R")
```

```{r, results='asis'}
library(texreg)

tc$postww2 <- ifelse(tc$year > 1945, 1, 0)

a1 <- glm(agreement ~ log(totflow+1), data=tc, family=binomial("logit"))

a2 <- glm(agreement ~ log(totflow+1) + contlose + contgain, data=tc, family=binomial("logit"))

a3 <- glm(agreement ~ log(totflow+1) + gaintype + losetype, data=tc, family=binomial("logit"))

a4 <- glm(agreement ~ log(totflow+1) + log(area) + log(pop+1), data=tc, family=binomial("logit"))

a5 <- glm(agreement ~ log(totflow+1) + portion, data=tc, family=binomial("logit"))

a6 <- glm(agreement ~ log(totflow+1) + portion + contlose + contgain + gaintype + losetype + log(area) + log(pop+1) + postww2, data=tc, family=binomial("logit"))

transfermap <- c("(Intercept)","log Total Trade", "Contiguous to Losing", "Contiguous to Gaining", "Gaining Homeland", "Losing Homeland", "log Area", "log Population", "Portion", "Post-WWII")

htmlreg(list(a1,a2,a3,a4,a5,a6), caption = "Agreement Logits (Transfer as Unit of Analysis)", doctype = F, custom.coef.names = transfermap, star.symbol = "\\*", stars = c(0.001,  0.01, 0.05, 0.1), symbol = "&#8224;")
```


## ICOW Settlement Attempts

```{r, cache=T}
library(haven)
library(readr)
library(dplyr)

# use dyad-year version of main claims data
claim <- read_dta("datasets/ICOWdata/ICOW Data 1.1/ICOWdyadyr.dta")

# add beg and end dates
dates <- read_csv("datasets/ICOWdata/ICOW Data 1.1/ICOWclaimdy.csv")

# subset to needed cols
dates <- select(dates, claimdy, begclaim, endclaim, resolved)

dates$claimdy <- as.numeric(dates$claimdy)

claim <- left_join(claim, dates)

# recode dyad nums
claim$dyad <- as.numeric(ifelse(claim$chal < claim$tgt, paste(claim$chal, claim$tgt, sep=""), paste(claim$tgt, claim$chal, sep="")))

# get claim beginning
claim$begyr <- as.numeric(substr(claim$begclaim, 1, 4))
claim$endyr <- as.numeric(substr(claim$endclaim, 1, 4))

claim$duration <- claim$year - claim$begyr
claim$end <- ifelse(claim$year==claim$endyr & !is.na(claim$resolved), 1, 0)
claim$time <- claim$year - 1816
claim$time2 <- claim$time + 1

# merge w/ trade data ----
trade <- read_csv("datasets/tradepred.csv")

trade <- select(trade, year, dyad, totflow, smoothtotrade, gravitypred)

#merge into main data
trade$year <- as.numeric(trade$year)
claim <- left_join(claim, trade)

rm(trade)

claim$ltotflow <- log(claim$totflow + 1)
claim$lduration <- log(claim$duration + 1)
claim$postww2 <- ifelse(claim$year > 1945, 1, 0)
```

```{r, results='asis'}
library(pglm)
source("extract_pglm.R")
setMethod("extract", signature = className("maxLik", "maxLik"), 
      definition = extract.pglm)

b1 <- pglm(attanyp ~ lag(log(totflow+1)), data=claim, index=c("claimdy","year"), model="pooling", effect="twoways", family=binomial("logit"))

b2 <- pglm(attanyp ~ lag(log(totflow+1)) + recno15 + recmid15, data=claim, index=c("claimdy","year"), model="pooling", effect="twoways", family=binomial("logit"))

b3 <- pglm(attanyp ~ lag(log(totflow+1)) + as.factor(issue), data=claim, index=c("claimdy","year"), model="pooling", effect="twoways", family=binomial("logit"))

b4 <- pglm(attanyp ~ lag(log(totflow+1)) + icowsal, data=claim, index=c("claimdy","year"), model="pooling", effect="twoways", family=binomial("logit"))

b5 <- pglm(attanyp ~ lag(log(totflow+1)) + log(duration + 1), data=claim, index=c("claimdy","year"), model="pooling", effect="twoways", family=binomial("logit"))
  
b6 <- pglm(attanyp ~ lag(log(totflow+1)) + recno15 + recmid15 + as.factor(issue) + icowsal + log(duration+1), data=claim, index=c("claimdy","year"), model="pooling", effect="twoways", family=binomial("logit"))

claimmap <- list("(Intercept)"="(Intercept)", 'lag(log(totflow + 1))'="log Total Trade", 'recno15'="Settlement Att within 15 Yrs", 'recmid15'="MID within 15 Yrs", 'as.factor(issue)2'="River Claim", 'as.factor(issue)3'="Maritime Claim", 'icowsal'="ICOW Salience", 'log(duration + 1)'="log Duration")
           
htmlreg(list(b1,b2,b3,b4,b5,b6), doctype = F,  caption = "ICOW Settlement Attempt Logits (ICOW Claim-Year as Unit of Analysis)", custom.coef.map = claimmap, star.symbol = "\\*", , stars = c(0.001, 0.01, 0.05, 0.1), symbol = "&#8224;")
```

Trade is robustly related to settlement attempts in ICOW claims. Substantively, a $1 million incresease in bilateral trade increases the probability of settlement attempt by about 7%. This is comparable to the effect of a 1 point increase on the ICOW salience scale.

## ICOW Claim Termination

```{r, results='asis'}
library(survival)

icow.surv <- Surv(claim$time, claim$end)
icow.surv2 <- Surv(claim$time, claim$time2, claim$end)

# s1 <- survfit(icow.surv ~ terriss, data=claim)
# plot(s1, mark.time = F, lty=1:2)

c1 <- coxph(icow.surv ~ ltotflow + postww2 + cluster(claimdy), data=claim, robust = T)
# summary(c1)
c2 <- coxph(icow.surv2 ~ ltotflow + terriss + riveriss + cluster(claimdy), data=claim, robust = T)

c3 <- coxph(icow.surv2 ~ ltotflow + icowsal + cluster(claimdy), data=claim, robust = T)

c4 <- coxph(icow.surv2 ~ ltotflow + recmid5 + recno5 + cluster(claimdy), data=claim, robust = T)

c5 <- coxph(icow.surv2 ~ ltotflow + terriss + riveriss + icowsal + recmid5 + recno5 + cluster(claimdy), data=claim, robust = T)

termmap <- list("(Intercept)"="(Intercept)", 'ltotflow'="log Trade", 'lag(log(totflow + 1))'="log Total Trade", 'recno15'="Settlement Att within 15 Yrs", 'recmid15'="MID within 15 Yrs", 'as.factor(issue)2'="River Claim", 'as.factor(issue)3'="Maritime Claim", 'terriss'="Territorial Issue", 'riveriss'="River Issue", 'icowsal'="ICOW Salience", 'log(duration + 1)'="log Duration","recmid5"="MID within 5 Yrs", 'recno5'="Settlement Att within 5 Yrs")

htmlreg(list(c1,c2,c3,c4, c5), doctype = F, caption = "Cox Proptional Hazard Models of ICOW Claim Termination", star.symbol = "\\*", custom.coef.map = termmap, , stars = c(0.001, 0.01, 0.05, 0.1), symbol = "&#8224;")
```

Trade does predict ICOW claim termination in a panel logit model, but in a survival model it does not. 

```{r, include=F}
library(dplyr)

condensed <- claim %>% 
  group_by(claimdy) %>% 
  summarize(begyr=min(begyr), endyr=max(endyr), avgtrade=mean(totflow, na.rm=T), end=max(end))

condensed.surv <- Surv(condensed$begyr, condensed$endyr, condensed$end)

condensed$ltrade <- log(condensed$avgtrade + 1)

condensed$decade <- as.numeric(substr(condensed$endyr, 1, 3))

c6 <- coxph(condensed.surv ~ ltrade + decade, data=condensed)
summary(c6)
```

## Border Settlement

```{r, cache=T}
source("ssq_data_creation.R")
```


```{r, results='asis'}

settle$t1 <- settle$year - 1816
settle$t2 <- settle$t1 + 1
settle$postww2 <- ifelse(settle$year >= 1945, 1, 0)

settle.surv <- Surv(settle$t1, settle$t2, settle$new_settle)

s1 <- coxph(settle.surv ~ log(totflow+1) + cluster(dyad), data=settle)

s2 <- coxph(settle.surv ~ log(totflow+1) + maxicowsal + cluster(dyad), data=settle)

s3 <- coxph(settle.surv ~ log(totflow+1) + joint_dem + cluster(dyad), data=settle)

s4 <- coxph(settle.surv ~ log(totflow+1) + maxicowsal + joint_dem + cluster(dyad), data=settle)

htmlreg(list(s1,s2,s3,s4), doctype = F, caption = "Cox Proptional Hazard Models of Border Settlement", star.symbol = "\\*", stars = c(0.001, 
    0.01, 0.05, 0.1), symbol = "&#8224;", custom.coef.names = c("log Total Trade", "ICOW Salience", "Joint Democracy"))
```

Trade predicts border settlement, but only at the 90% level. This adds up to a consistent story - trade influences the manner in which territorial issues are handled when they arise, but alone it is not a significant impetus for more comprehensive territorial settlements.

## Trade as a DV




## 2-Stage Models

As we discussed, a two-stage model makes sense theoretically, but given the structure of our data the options are limited. One possibility is a panel Heckman selection model. The catch is that we would need an instrument for legalized transfers/ICOW settlement attempts. I can't find any instruments for these in the literature. Unless you have any ideas, perhaps we should submit separate analyses and hope the reviewers don't have any other ideas that break the results.

- Panel Heckman
  - Requires instrument
- Condensed Heckman
- 